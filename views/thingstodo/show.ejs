<!DOCTYPE html>
<html lang="en">
<!-- Head Partial -->
<%- include('../partials/head/head.ejs', { page: thingstodo.title }) %>

    <body>
        <!-- Navbar Partial -->
        <%- include ('../partials/navbar/navbar.ejs') %>
        <div class="container">
            <h1>Things To Do Show Page</h1>
            
            <img src="<%= thingstodo.image %> " alt="<%= thingstodo.title %> " />
            <p>
                <%= thingstodo.title %>
            </p>
            <p>
                <%= thingstodo.description %>
            </p>
        </div>

            <!-- REVIEW AREA  -->
            <h1>REVIEWS</h1>
            <% reviews.forEach(allReview=> { %>
                <p>
                    <%= allReview.rating %>/5
                </p>
                <p>@<%= allReview.user.username %>:</p>
                <p>" <%= allReview.content %> "</p>
                <p>
                    <%= new Date(allReview.createdAt).toLocaleString() %>
                </p>

                <!-- EACH REVIEW MODAL -->
                <div class="modal fade" id="allReviewModal-<%= allReview._id %>" tabindex="-1"
                    aria-labelledby="allReviewModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="allReviewModalLabel">Edit Review!</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                    aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div class="container">
                                    <form action="/reviews/<%= allReview._id %>?_method=PUT" method="POST">
                                        <div class="mb-3">
                                            <label>Rating</label>
                                            <div>
                                                <input type="number" name="rating" min="1" max="5" placeholder="1-5"
                                                    value="<%= allReview.rating %>" required />
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label>Content</label>
                                            <div>
                                                <input type="text" name="content" minlength="1" maxlength="100"
                                                    placeholder="What do you think?" value="<%= allReview.content %> "
                                                    required />
                                            </div>
                                        </div>

                                        <!-- Here is our hidden input to provide the thingstodo id -->
                                        <input type="hidden" name="thingstodo" value="<%= thingstodo._id %>" />

                                        <div class="modal-footer">
                                            <button type="submit" class="btn btn-primary">Submit</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- If User is logged in -->
                <% if (typeof user !=='undefined' ) { %>
                    <div id="review-edit-delete">
                        <button type="button" class="toggle-modal" data-bs-toggle="modal"
                            data-bs-target="#allReviewModal-<%= allReview._id %>">
                            Edit
                        </button>

                        <!-- DELETE trigger modal -->
                        <button type="button" class="toggle-modal" data-bs-toggle="modal"
                            data-bs-target="#deleteModal-<%= allReview._id %>">
                            Delete
                        </button>
                    </div>
                    <% } %>

                        <!-- DELETE Modal -->
                        <div class="modal fade" id="deleteModal-<%= allReview._id %>" tabindex="-1"
                            aria-labelledby="deleteModalLabel" aria-hidden="true">
                            <div class="modal-dialog modal-dialog-centered">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="deleteModalLabel">
                                            Are you sure you want to delete this review?
                                        </h5>
                                    </div>
                                    <div class="modal-body">" <%= allReview.content %> "</div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                            Cancel
                                        </button>
                                        <form action="/reviews/<%= allReview._id %>?_method=DELETE" method="POST">
                                            <button class="btn btn-primary">Confirm</button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <% }) %>

                            <!-- Review Button trigger modal -->
                            <button type="button" class="btn btn-primary" data-bs-toggle="modal"
                                data-bs-target="#reviewModal">
                                Create Review!
                            </button>

                            <!-- REVIEW MODAL -->
                            <div class="modal fade" id="reviewModal" tabindex="-1" aria-labelledby="reviewModalLabel"
                                aria-hidden="true">
                                <div class="modal-dialog modal-dialog-centered">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title" id="reviewModalLabel">Create Review!</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                aria-label="Close"></button>
                                        </div>
                                        <div class="modal-body">
                                            <div class="container">
                                                <form action="/reviews?redirect=thingstodo%2F<%= thingstodo._id %>"
                                                    method="POST">
                                                    <div class="mb-3">
                                                        <label>Rating</label>
                                                        <div>
                                                            <input type="number" name="rating" min="1" max="5"
                                                                placeholder="1-5" required />
                                                        </div>
                                                    </div>
                                                    <div class="mb-3">
                                                        <label>Content</label>
                                                        <div>
                                                            <input type="text" name="content" minlength="1"
                                                                maxlength="100" placeholder="What do you think?"
                                                                required />
                                                        </div>
                                                    </div>

                                                    <!-- Here is our hidden input to provide the thingstodo id -->
                                                    <input type="hidden" name="thingstodo"
                                                        value="<%= thingstodo._id %>" />

                                                    <% if (typeof user !=='undefined' ) { %>
                                                        <!-- Here is our hidden input to provide the user id -->
                                                        <input type="hidden" name="user" value="<%= user._id %>" />
                                                        <div class="modal-footer">
                                                            <button type="submit"
                                                                class="btn btn-primary">Submit</button>
                                                        </div>
                                                        <% } else if (typeof user==='undefined' ) { %>
                                                            <div class="modal-footer">
                                                                <button type="submit"
                                                                    class="btn btn-primary">Submit</button>
                                                            </div>
                                                            <% } %>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Back to top button -->
                            <button
                            type="button"
                            class="btn btn-danger btn-floating btn-sml"
                            id="btn-back-to-top"
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="currentColor" class="bi bi-arrow-up-circle-fill" viewBox="0 0 16 16">
                                    <path d="M16 8A8 8 0 1 0 0 8a8 8 0 0 0 16 0zm-7.5 3.5a.5.5 0 0 1-1 0V5.707L5.354 7.854a.5.5 0 1 1-.708-.708l3-3a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 5.707V11.5z"/>
                                </svg>
                                TOP OF PAGE
                            </button>
    </body>
</html>